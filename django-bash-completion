# ./manage.py completion "Django Admin - Django 1.11)

MANAGE_PY_SUBCOMMANDS="changepassword createsuperuser remove_stale_contenttypes check compilemessages createcachetable dbshell diffsettings dumpdata flush inspectdb loaddata makemessages makemigrations migrate sendtestemail shell showmigrations sqlflush sqlmigrate sqlsequencereset squashmigrations startapp startproject test testserver admin_generator clean_pyc clear_cache compile_pyc create_app create_command create_jobs create_template_tags delete_squashed_migrations describe_form drop_test_database dumpscript export_emails find_template generate_secret_key graph_models mail_debug notes passwd pipchecker print_settings print_user_for_session reset_db runjob runjobs runprofileserver runscript runserver_plus set_default_site set_fake_emails set_fake_passwords shell_plus show_template_tags show_templatetags show_urls sqlcreate sqldiff sqldsn sync_s3 syncdata unreferenced_files update_permissions validate_templates clearsessions collectstatic findstatic runserver"

declare -A MANAGE_PY_SUBCOMMANDS_OPTIONS

MANAGE_PY_SUBCOMMANDS_OPTIONS[changepassword]="--help --settings --no-color --traceback --database --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[createsuperuser]="--help --settings --no-color --traceback --database --email --verbosity --version --username --no-input --pythonpath --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[remove_stale_contenttypes]="--help --settings --no-color --traceback --database --verbosity --version --pythonpath --no-input --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[check]="--help --settings --no-color --traceback --list-tags --fail-level --tag --deploy --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[compilemessages]="--help --settings --no-color --traceback --use-fuzzy --verbosity --locale --version --pythonpath --exclude"
MANAGE_PY_SUBCOMMANDS_OPTIONS[createcachetable]="--help --settings --no-color --traceback --database --dry-run --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[dbshell]="--help --settings --no-color --traceback --database --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[diffsettings]="--help --settings --no-color --traceback --verbosity --version --default --pythonpath --all"
MANAGE_PY_SUBCOMMANDS_OPTIONS[dumpdata]="--help --settings --no-color --format --traceback --natural-foreign --database --verbosity --version --exclude --pythonpath --output --pks --natural-primary --indent --all"
MANAGE_PY_SUBCOMMANDS_OPTIONS[flush]="--help --settings --no-color --traceback --database --verbosity --version --pythonpath --no-input --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[inspectdb]="--help --settings --no-color --traceback --database --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[loaddata]="--ignorenonexistent --help --settings --no-color --traceback --database --verbosity --version --pythonpath --exclude --app"
MANAGE_PY_SUBCOMMANDS_OPTIONS[makemessages]="--ignore --help --settings --no-color --traceback --symlinks --no-default-ignore --no-location --no-wrap --keep-pot --verbosity --locale --version --extension --pythonpath --domain --exclude --no-obsolete --all"
MANAGE_PY_SUBCOMMANDS_OPTIONS[makemigrations]="app_label migration_name --help --merge --settings --no-color --traceback --name --dry-run --verbosity --empty --check --exit --version --pythonpath --no-input --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[migrate]="app_label migration_name --run-syncdb --help --settings --no-color --traceback --database --verbosity --fake --version --pythonpath --no-input --fake-initial --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[sendtestemail]="--help --settings --no-color --traceback --verbosity --version --pythonpath --managers --admins"
MANAGE_PY_SUBCOMMANDS_OPTIONS[shell]="--help --settings --no-color --traceback --no-startup --interface --command --verbosity --version --plain --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[showmigrations]="--help --settings --no-color --traceback --database --verbosity --list --plan --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[sqlflush]="--help --settings --no-color --traceback --database --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[sqlmigrate]="--help --settings --no-color --traceback --database --backwards --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[sqlsequencereset]="--help --settings --no-color --traceback --database --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[squashmigrations]="--help --settings --no-color --traceback --no-optimize --verbosity --version --pythonpath --no-input --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[startapp]="--help --settings --no-color --traceback --name --verbosity --template --version --extension --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[startproject]="--help --settings --no-color --traceback --name --verbosity --template --version --extension --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[test]="--help --testrunner --top-level-directory --settings --no-color --traceback --keepdb --debug-sql --reverse --tag --verbosity --failfast --version --debug-mode --pythonpath --parallel --no-input --pattern --exclude-tag --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[testserver]="--help --settings --no-color --traceback --ipv6 --addrport --verbosity --version --pythonpath --no-input --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[admin_generator]="--help --raw-id-threshold --settings --no-color --traceback --date-hierarchy --list-filter-threshold --verbosity --version --prepopulated-fields --pythonpath --search-field"
MANAGE_PY_SUBCOMMANDS_OPTIONS[clean_pyc]="--help --path --settings --no-color --traceback --optimize --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[clear_cache]="--help --settings --no-color --traceback --cache --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[compile_pyc]="--help --path --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[create_app]="--help --settings --no-color --traceback --parent_path --verbosity --template --version --pythonpath --diagram"
MANAGE_PY_SUBCOMMANDS_OPTIONS[create_command]="--help --settings --no-color --traceback --name --dry-run --base --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[create_jobs]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[create_template_tags]="--help --settings --no-color --traceback --name --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[delete_squashed_migrations]="--help --settings --no-color --traceback --dry-run --verbosity --version --pythonpath --no-input --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[describe_form]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[drop_test_database]="--password --help --settings --no-color --traceback --verbosity --version --dbname --pythonpath --user --noinput --router"
MANAGE_PY_SUBCOMMANDS_OPTIONS[dumpscript]="--help --settings --no-color --traceback --autofield --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[export_emails]="--help --settings --no-color --traceback --format --group --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[find_template]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[generate_secret_key]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[graph_models]="--no-color --hide-relations-from-fields --include-models --disable-fields --pydot --help --pygraphviz --verbosity --no-inheritance --output --language --disable-sort-fields --layout --settings --traceback --verbose-names --all-applications --version --pythonpath --exclude-columns --inheritance --group-models --exclude-models --json"
MANAGE_PY_SUBCOMMANDS_OPTIONS[mail_debug]="--use-settings --help --settings --no-color --traceback --verbosity --version --output --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[notes]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[passwd]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[pipchecker]="--help --settings --no-color --traceback --github-api-token --requirement --verbosity --newer --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[print_settings]="--help --settings --no-color --format --traceback --verbosity --version --pythonpath --indent"
MANAGE_PY_SUBCOMMANDS_OPTIONS[print_user_for_session]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[reset_db]="--password --help --settings --no-color --traceback --close-sessions --verbosity --owner --version --dbname --pythonpath --user --no-utf8 --noinput --router"
MANAGE_PY_SUBCOMMANDS_OPTIONS[runjob]="--help --settings --no-color --traceback --verbosity --list --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[runjobs]="--help --settings --no-color --traceback --verbosity --list --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[runprofileserver]="--nostatic --prof-file --help --settings --no-color --traceback --insecure --verbosity --noreload --nothreading --prof-path --version --nomedia --pythonpath --use-cprofile --kcachegrind"
MANAGE_PY_SUBCOMMANDS_OPTIONS[runscript]="--help --no-traceback --settings --no-color --traceback --noscripts --script-args --verbosity --email-exception --silent --version --email-notifications --fixtures --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[runserver_plus]="--pdb --ipv6 --no-color --print-sql --insecure --nopin --pm --keep-meta-shutdown --cert --nostatic --help --verbosity --nothreading --reloader-interval --output --extra-file --startup-messages --settings --traceback --noreload --version --pythonpath --ipdb --browser --threaded"
MANAGE_PY_SUBCOMMANDS_OPTIONS[set_default_site]="--help --settings --no-color --traceback --name --verbosity --system-fqdn --version --pythonpath --domain"
MANAGE_PY_SUBCOMMANDS_OPTIONS[set_fake_emails]="--no-staff --help --exclude-groups --settings --no-color --traceback --include-groups --no-admin --email --include --verbosity --version --pythonpath --exclude"
MANAGE_PY_SUBCOMMANDS_OPTIONS[set_fake_passwords]="--password --help --settings --no-color --traceback --prompt --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[shell_plus]="--ptpython --help --settings --no-color --traceback --bpython --print-sql --vi --notebook --quiet-load --verbosity --connection-file --use-pythonrc --ptipython --kernel --version --plain --pythonpath --dont-load --no-browser --ipython"
MANAGE_PY_SUBCOMMANDS_OPTIONS[show_template_tags]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[show_templatetags]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[show_urls]="--help --settings --no-color --traceback --format --urlconf --decorator --verbosity --version --language --pythonpath --unsorted"
MANAGE_PY_SUBCOMMANDS_OPTIONS[sqlcreate]="--help --settings --no-color --traceback --verbosity --version --pythonpath --drop --router"
MANAGE_PY_SUBCOMMANDS_OPTIONS[sqldiff]="--help --settings --no-color --traceback --dense-output --output_text --verbosity --all-applications --version --not-only-existing --pythonpath --include-proxy-models"
MANAGE_PY_SUBCOMMANDS_OPTIONS[sqldsn]="--style --help --settings --no-color --traceback --quiet --all --verbosity --version --pythonpath --router"
MANAGE_PY_SUBCOMMANDS_OPTIONS[sync_s3]="--prefix --help --renamegzip --settings --no-color --traceback --expires --filter-list --dir --invalidate --verbosity --gzip --version --s3host --pythonpath --acl --force --static-only --media-only"
MANAGE_PY_SUBCOMMANDS_OPTIONS[syncdata]="--help --settings --no-color --traceback --verbosity --version --pythonpath --skip-remove"
MANAGE_PY_SUBCOMMANDS_OPTIONS[unreferenced_files]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[update_permissions]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[validate_templates]="--break --help --settings --no-color --traceback --verbosity --include --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[clearsessions]="--help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[collectstatic]="--ignore --help --settings --no-color --traceback --no-default-ignore --no-post-process --link --dry-run --verbosity --clear --version --pythonpath --no-input --noinput"
MANAGE_PY_SUBCOMMANDS_OPTIONS[findstatic]="--first --help --settings --no-color --traceback --verbosity --version --pythonpath"
MANAGE_PY_SUBCOMMANDS_OPTIONS[runserver]="--nostatic --help --settings --ipv6 --traceback --no-color --insecure --verbosity --nothreading --noreload --version --pythonpath"

function find_applications() {
	local apps=""
	for app in $(ls */__init__.py 2>/dev/null); do
		apps+=" $(dirname $app)"
	done
	echo $apps
}

function find_migrations_names() {
	local app="$1"
	if [ "$app" == "" ]; then
		app='*'
	fi
	local migrations=""
	for migration in $(ls $app/migrations/[0-9]*.py 2>/dev/null); do
		migrations+=" $migration"
	done
	echo $migrations
}

function get_arguments_for_command() {
	local command="$1"
	local app=
	if [ ! -z "$2" -a "$2" != "./manage.py" ]; then  # FIXME: Use a variable to set './manage.py' name.
		command="$2"
		app="$1"
	fi
	if [ ${MANAGE_PY_SUBCOMMANDS_OPTIONS[$command]+isset} ]; then
		local the_list="${MANAGE_PY_SUBCOMMANDS_OPTIONS[$command]}"
		if [ -z "$app" ]; then
			if [[ $the_list =~ app_label ]]; then
				the_list="$(find_applications) $the_list"
			fi
		fi
		the_list=${the_list##app_label}  # FIXME: Remove 'app_label'; this does not work
		if [[ $the_list =~ migration_name ]]; then
			if [ -z "$app" -a -d "$command" ]; then
				app=$command
			fi
			the_list="$(find_migrations_names $app) $the_list"
		fi
		the_list=${the_list##migration_name}  # FIXME: Remove 'migration_name'; this does not work
		echo $the_list
	else
		echo $MANAGE_PY_SUBCOMMANDS
	fi
}

function django_admin_completion() {
	local cur=${COMP_WORDS[COMP_CWORD]}
	local prev=${COMP_WORDS[COMP_CWORD-1]}
	local prev_prev=${COMP_WORDS[COMP_CWORD-2]}
	COMPREPLY=( $(compgen -W "$(get_arguments_for_command ${prev} ${prev_prev})" -- ${cur}) )
}

complete -F django_admin_completion ./manage.py manage.py
